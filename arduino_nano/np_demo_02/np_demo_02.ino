#include <Adafruit_NeoPixel.h>

// -----------------------------------------------------------------------------
// ðŸ“Œ åƒæ•¸è¨­å®š
// -----------------------------------------------------------------------------
#define PIN             2    // Neopixel æ•¸æ“šè…³ä½ (D2)
#define BUTTON_PIN      4    // å­å½ˆæŒ‰éˆ•è…³ä½ (D4)
#define NUMPIXELS       20   // ç‡ˆæ¢ä¸Šçš„ç‡ˆç æ•¸é‡ (Index 0 - 19)
#define MOVE_INTERVAL   1000 // ç‡ˆå…‰ç§»å‹•/ç”Ÿæˆçš„æ™‚é–“é–“éš” (1000ms = 1ç§’)

// å®šç¾©é¡è‰² (ä½Žäº®åº¦ä»¥ä¿è­·çœ¼ç›å’Œç¯€çœé›»åŠ›)
const uint32_t LED_COLOR = Adafruit_NeoPixel::Color(0, 20, 0);   // ç¶ è‰²ç§»å‹•ç‡ˆ
const uint32_t GAMEOVER_COLOR = Adafruit_NeoPixel::Color(20, 0, 0); // ç´…è‰²éŠæˆ²çµæŸç‡ˆ

// -----------------------------------------------------------------------------
// ðŸ’¾ ç‹€æ…‹è®Šæ•¸
// -----------------------------------------------------------------------------
Adafruit_NeoPixel pixels(NUMPIXELS, PIN, NEO_GRB + NEO_KHZ800);

// è¨˜éŒ„æ¯é¡†ç‡ˆçš„ç‹€æ…‹ (true=äº®, false=æ»…)ã€‚Index 0 æ˜¯æœ€é è¿‘çŽ©å®¶çš„ç‡ˆã€‚
bool pixelState[NUMPIXELS] = {false}; 

unsigned long lastMoveTime = 0; // è¨˜éŒ„ä¸Šæ¬¡ç§»å‹•/ç”Ÿæˆç‡ˆçš„æ™‚é–“
bool isGameOver = false;        // éŠæˆ²ç‹€æ…‹æ——æ¨™
int buttonState = 0;            // ç•¶å‰æŒ‰éˆ•ç‹€æ…‹
int lastButtonState = 0;        // ä¸Šæ¬¡æŒ‰éˆ•ç‹€æ…‹

// -----------------------------------------------------------------------------
// âš™ï¸ setup() åˆå§‹è¨­å®š
// -----------------------------------------------------------------------------
void setup() {
  Serial.begin(9600);
  
  // è¨­å®šæŒ‰éˆ•è…³ä½ç‚ºè¼¸å…¥ï¼Œä¸¦å•Ÿç”¨å…§å»ºä¸Šæ‹‰é›»é˜»
  pinMode(BUTTON_PIN, INPUT_PULLUP); 

  pixels.begin();
  pixels.show(); // åˆå§‹åŒ–æ™‚å…¨éƒ¨ç†„æ»…
}

// -----------------------------------------------------------------------------
// ðŸ”„ loop() è¿´åœˆåŸ·è¡Œ
// -----------------------------------------------------------------------------
void loop() {
  if (isGameOver) {
    // éŠæˆ²çµæŸæ™‚ï¼ŒåªåŸ·è¡ŒçµæŸé‚è¼¯
    gameOverSequence();
    return; // çµæŸ loop()
  }

  // 1. è™•ç†ç‡ˆå…‰ç§»å‹•å’Œç”Ÿæˆ (æ¯ MOVE_INTERVAL åŸ·è¡Œä¸€æ¬¡)
  if (millis() - lastMoveTime >= MOVE_INTERVAL) {
    handleLightMovement();
    lastMoveTime = millis();
  }

  // 2. è™•ç†å­å½ˆå°„æ“Š (æŒ‰éˆ•æŒ‰ä¸‹æ™‚)
  handleShooting();

  // 3. ç¹ªè£½ç‡ˆæ¢
  drawLights();
}

// -----------------------------------------------------------------------------
// ðŸŽ¯ è™•ç†ç‡ˆå…‰ç§»å‹•å’Œç”Ÿæˆ (æ¯ç§’åŸ·è¡Œ)
// -----------------------------------------------------------------------------
void handleLightMovement() {
  
  // A. æª¢æŸ¥éŠæˆ²çµæŸæ¢ä»¶ (Index 0 çš„ç‡ˆæ˜¯å¦äº®è‘—)
  if (pixelState[0] == true) {
    Serial.println("Game Over: Light reached Index 0!");
    isGameOver = true;
    return;
  }

  // B. ç‡ˆå…‰ç§»å‹• (å¾ž Index 18 ç§»åˆ° 1ï¼ŒIndex 19 è¢«æ–°ç‡ˆå–ä»£)
  // ç”±æœ€å° Index é–‹å§‹æª¢æŸ¥ï¼Œç¢ºä¿ç§»å‹•æ˜¯æ­£ç¢ºçš„ (i -> i-1)
  for (int i = 1; i < NUMPIXELS; i++) {
    // å°‡å‰ä¸€å€‹ç‡ˆçš„ç‹€æ…‹è³¦äºˆçµ¦ç•¶å‰ç‡ˆ
    pixelState[i - 1] = pixelState[i]; 
  }

  // C. éš¨æ©Ÿç”Ÿæˆæ–°ç‡ˆ (åœ¨ Index 19)
  // äº‚æ•¸çµ¦ä¸€å€‹ bit (0 æˆ– 1)
  int randomBit = random(2); // ç”¢ç”Ÿ 0 æˆ– 1

  if (randomBit == 1) {
    pixelState[NUMPIXELS - 1] = true; // Index 19 (ç¬¬ 20 é¡†ç‡ˆ) äº®èµ·
    Serial.println("New light generated at Index 19.");
  } else {
    pixelState[NUMPIXELS - 1] = false; // Index 19 ç†„æ»…
    Serial.println("No light generated.");
  }
}

// -----------------------------------------------------------------------------
// ðŸ”« è™•ç†å­å½ˆå°„æ“Š (æŒ‰éˆ•D4)
// -----------------------------------------------------------------------------
void handleShooting() {
  // è®€å–æŒ‰éˆ•ç‹€æ…‹ (INPUT_PULLUP: LOW = æŒ‰ä¸‹, HIGH = é¬†é–‹)
  buttonState = digitalRead(BUTTON_PIN);

  // æª¢æ¸¬æŒ‰éˆ•å¾ž é¬†é–‹ (HIGH) è®Šæˆ æŒ‰ä¸‹ (LOW) çš„çž¬é–“ (ä¸‹é™ç·£è§¸ç™¼)
  if (buttonState == LOW && lastButtonState == HIGH) {
    
    // å°‹æ‰¾æœ€å° Index ä¸”äº®è‘—çš„ç‡ˆ (æœ€é è¿‘çŽ©å®¶çš„ç›®æ¨™)
    for (int i = 0; i < NUMPIXELS; i++) {
      if (pixelState[i] == true) {
        // æ‰¾åˆ°ç›®æ¨™ï¼Œå°‡å…¶æ“Šæ»…
        pixelState[i] = false; 
        Serial.print("Bullet fired! Hit target at Index: ");
        Serial.println(i);
        break; // åªæ“Šæ»…ä¸€å€‹ç›®æ¨™
      }
    }
  }

  // å„²å­˜ç•¶å‰ç‹€æ…‹ï¼Œç”¨æ–¼ä¸‹ä¸€è¼ªåˆ¤æ–·
  lastButtonState = buttonState;
}

// -----------------------------------------------------------------------------
// ðŸŽ¨ ç¹ªè£½ç‡ˆæ¢ (å°‡ç‹€æ…‹é™£åˆ—è½‰æ›ç‚ºå¯¦éš›ç‡ˆå…‰)
// -----------------------------------------------------------------------------
void drawLights() {
  for (int i = 0; i < NUMPIXELS; i++) {
    if (pixelState[i] == true) {
      pixels.setPixelColor(i, LED_COLOR); // äº®ç¶ è‰²
    } else {
      pixels.setPixelColor(i, 0);         // ç†„æ»… (R=0, G=0, B=0)
    }
  }
  pixels.show(); // æ›´æ–°ç‡ˆæ¢
}

// -----------------------------------------------------------------------------
// ðŸ›‘ éŠæˆ²çµæŸåºåˆ—
// -----------------------------------------------------------------------------
void gameOverSequence() {
  // å…¨éƒ¨ç‡ˆäº®ç´…è‰²
  for(int i=0; i < NUMPIXELS; i++) {
    pixels.setPixelColor(i, GAMEOVER_COLOR);
  }
  pixels.show();
  
  // æš«åœä¸€ä¸‹ï¼Œç­‰å¾…é‡ç½® (å¦‚æžœéœ€è¦é‡å•Ÿï¼Œéœ€è¦åŠ å…¥é‡ç½®æŒ‰éˆ•æˆ–å»¶é²å¾Œé‡å•Ÿçš„é‚è¼¯)
  // é€™è£¡åªè®“å®ƒä¿æŒç´…ç‡ˆç‹€æ…‹
  delay(100); 
}
